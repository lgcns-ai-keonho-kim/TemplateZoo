#!/usr/bin/env bash

set -euo pipefail

msg_file="${1:?commit message file is required}"

today="$(date +%Y%m%d)"
today_start="$(date '+%Y-%m-%d 00:00:00 %z')"
last_version="$(
  git log --all --since="$today_start" --pretty=format:'%s' 2>/dev/null \
    | sed -nE "s/^${today}\\.v([0-9]+)([[:space:]].*)?$/\\1/p" \
    | sort -n \
    | tail -n 1 \
    || true
)"
if [[ -n "$last_version" ]]; then
  next_number="$((last_version + 1))"
else
  next_number=1
fi
prefix="${today}.v${next_number}"

has_message="$(
  sed '/^[[:space:]]*#/d;/^[[:space:]]*$/d' "$msg_file" | head -n 1 || true
)"

if [[ -z "$has_message" ]]; then
  {
    printf '%s\n\n' "$prefix"
    cat "$msg_file"
  } > "${msg_file}.tmp"
  mv "${msg_file}.tmp" "$msg_file"
  exit 0
fi

if [[ "$has_message" =~ ^[0-9]{8}\.v[0-9]+([[:space:]]|$) ]]; then
  exit 0
fi

awk -v prefix="$prefix" '
BEGIN {
  updated = 0
}
{
  if (!updated && $0 !~ /^[[:space:]]*#/ && $0 !~ /^[[:space:]]*$/) {
    print prefix " " $0
    updated = 1
  } else {
    print $0
  }
}
' "$msg_file" > "${msg_file}.tmp"

mv "${msg_file}.tmp" "$msg_file"
